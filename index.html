<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>下滑刷新图片</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    #pullArea {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
    }
    #gallery {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      padding: 6px;
    }
    #gallery img {
      width: 100%;
      border-radius: 8px;
      background: #ddd;
      touch-action: manipulation;
    }

    /* viewer 样式 */
    #viewer {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.92);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      -webkit-tap-highlight-color: transparent;
    }
    #viewer img {
      max-width: 100%;
      max-height: 100%;
      user-select: none;
      -webkit-user-drag: none;
      touch-action: none;
      transition: transform 180ms ease;
    }
  </style>
</head>
<body>
  <div id="pullArea">下拉刷新随机图片...</div>
  <div id="gallery"></div>

  <!-- 全屏查看节点 -->
  <div id="viewer"><img id="viewerImg" alt="preview" /></div>

  <script>
    const TOTAL = 9127; // 假设总数
    let refreshCount = 0;

    // 随机生成图片数组
    function getRandomImages() {
      const arr = [];
      const used = new Set();
      while (arr.length < 10) {
        const n = Math.floor(Math.random() * TOTAL) + 1;
        if (!used.has(n)) {
          used.add(n);
          arr.push(`photos/${n}.jpg`);
        }
      }
      return arr;
    }

    function loadImages() {
      refreshCount++;

      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      let imgs = getRandomImages();

      // 每刷新 5 次，必定出现 code.jpg
      if (refreshCount % 5 === 0) {
        const insertPos = Math.floor(Math.random() * imgs.length);
        imgs.splice(insertPos, 0, "photos/code.jpg");
        imgs = imgs.slice(0, 10); // 保持总数 10 张
      }

      imgs.forEach((src, index) => {
        const img = document.createElement("img");
        img.src = src;
        img.dataset.index = index;
        img.addEventListener("click", () => openViewer(index, imgs));
        gallery.appendChild(img);
      });

      window.currentImages = imgs;
    }

    loadImages();

    /* ---------- 下拉刷新 ---------- */
    let startY = 0;
    let pulling = false;
    document.addEventListener("touchstart", e => {
      startY = e.touches[0].clientY;
      pulling = false;
    });
    document.addEventListener("touchmove", e => {
      const y = e.touches[0].clientY;
      if (window.scrollY === 0 && y - startY > 60) {
        pulling = true;
        document.getElementById("pullArea").innerText = "松开刷新...";
      }
    });
    document.addEventListener("touchend", () => {
      if (pulling) {
        document.getElementById("pullArea").innerText = "正在刷新...";
        setTimeout(() => {
          loadImages();
          document.getElementById("pullArea").innerText = "下拉刷新随机图片...";
        }, 500);
      }
    });

    /* ---------- 全屏查看 & 锁定滚动 ---------- */
    const viewer = document.getElementById('viewer');
    const viewerImg = document.getElementById('viewerImg');
    let currentIndex = 0;
    let savedScrollY = 0;

    function preventTouchMove(e) {
      e.preventDefault();
    }

    function openViewer(index, list) {
      currentIndex = index;
      window.currentImages = list;
      savedScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;

      document.body.style.position = 'fixed';
      document.body.style.top = `-${savedScrollY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';

      viewer.style.display = 'flex';
      viewerImg.src = list[index];

      viewer.addEventListener('touchmove', preventTouchMove, { passive: false });
      document.addEventListener('touchmove', preventTouchMove, { passive: false });
    }

    function closeViewer() {
      viewer.style.display = 'none';
      viewerImg.src = '';

      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';

      window.scrollTo(0, savedScrollY);

      viewer.removeEventListener('touchmove', preventTouchMove, { passive: false });
      document.removeEventListener('touchmove', preventTouchMove, { passive: false });
    }

    viewer.addEventListener('click', closeViewer);

    // 左右滑动切换
    let startX = 0;
    viewer.addEventListener('touchstart', e => {
      if (!e.touches || e.touches.length === 0) return;
      startX = e.touches[0].clientX;
    }, { passive: true });

    viewer.addEventListener('touchend', e => {
      if (!e.changedTouches || e.changedTouches.length === 0) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (dx > 60) {
        currentIndex = (currentIndex - 1 + window.currentImages.length) % window.currentImages.length;
        viewerImg.src = window.currentImages[currentIndex];
      } else if (dx < -60) {
        currentIndex = (currentIndex + 1) % window.currentImages.length;
        viewerImg.src = window.currentImages[currentIndex];
      }
    }, { passive: true });

    // 桌面支持左右键切换，Esc 关闭
    document.addEventListener('keydown', (e) => {
      if (viewer.style.display !== 'flex') return;
      if (e.key === 'ArrowLeft') {
        currentIndex = (currentIndex - 1 + window.currentImages.length) % window.currentImages.length;
        viewerImg.src = window.currentImages[currentIndex];
      } else if (e.key === 'ArrowRight') {
        currentIndex = (currentIndex + 1) % window.currentImages.length;
        viewerImg.src = window.currentImages[currentIndex];
      } else if (e.key === 'Escape') {
        closeViewer();
      }
    });
  </script>
</body>
</html>
